# =============================================================================
# CI/CD Pipeline Part 3: Post-Deploy Security & Quality Scans
# Uploads artifacts to S3: dev/, uat/, prod/ folders
# =============================================================================

name: "ðŸš€ CI/CD Pipeline Part 3 - Post Deploy"

on:
  workflow_run:
    workflows: ["ðŸš€ CI/CD Pipeline Part 2"]
    types: [completed]

env:
  AWS_REGION: us-east-1

jobs:
  phpunit:
    name: "ðŸ§ª PHPUnit Tests"
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, json, bcmath, tokenizer
          coverage: none
      - name: Install backend dependencies
        working-directory: backend
        run: composer install --no-interaction --prefer-dist --optimize-autoloader
      - name: Run PHPUnit tests
        working-directory: backend
        run: vendor/bin/phpunit --configuration phpunit.xml.dist

  # ==========================================================================
  # Setup Environment Detection
  # ==========================================================================
  setup:
    name: "âš™ï¸ Setup"
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      target_url: ${{ steps.env.outputs.target_url }}
    steps:
      - name: Determine Environment
        id: env
        run: |
          BRANCH="${{ github.event.workflow_run.head_branch }}"
          if [[ "$BRANCH" == "main" ]]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
            echo "target_url=https://karthik.uk" >> $GITHUB_OUTPUT
          elif [[ "$BRANCH" == "develop" ]]; then
            echo "environment=dev" >> $GITHUB_OUTPUT
            echo "target_url=https://dev.karthik.uk" >> $GITHUB_OUTPUT
          else
            echo "environment=uat" >> $GITHUB_OUTPUT
            echo "target_url=https://uat.karthik.uk" >> $GITHUB_OUTPUT
          fi

  # ==========================================================================
  # STAGE 11: OWASP ZAP Scan
  # ==========================================================================
  owasp-zap:
    name: "ðŸ” Stage 11: OWASP ZAP"
    runs-on: ubuntu-latest
    needs: setup
    env:
      ENV: ${{ needs.setup.outputs.environment }}
      TARGET: ${{ needs.setup.outputs.target_url }}
    steps:
      - name: "ðŸ” Log - Starting OWASP ZAP"
        run: |
          echo "=========================================="
          echo "ðŸ” STAGE 11: OWASP ZAP SCAN (POST-DEPLOY)"
          echo "=========================================="
          echo "Environment: ${{ env.ENV }}"
          echo "Target URL: ${{ env.TARGET }}"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Create ZAP Rules File
        run: |
          mkdir -p .zap
          cat > .zap/rules.tsv << 'EOF'
          10010	IGNORE	(Cookie No HttpOnly Flag)
          10011	IGNORE	(Cookie Without Secure Flag)
          10015	WARN	(Incomplete or No Cache-control Header Set)
          10020	WARN	(X-Frame-Options Header)
          10021	WARN	(X-Content-Type-Options Header Missing)
          10038	WARN	(Content Security Policy Header Not Set)
          EOF

      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: ${{ env.TARGET }}
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -j'
        continue-on-error: true

      - name: "ðŸ“ Prepare OWASP Report"
        run: |
          mkdir -p owasp-zap-report
          mv report_html.html owasp-zap-report/ 2>/dev/null || true
          mv report_json.json owasp-zap-report/ 2>/dev/null || true
          mv report_md.md owasp-zap-report/ 2>/dev/null || true
          cat > owasp-zap-report/zap-summary.json << EOF
          {
            "scanType": "baseline",
            "target": "${{ env.TARGET }}",
            "environment": "${{ env.ENV }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${{ github.event.workflow_run.head_sha }}",
            "branch": "${{ github.event.workflow_run.head_branch }}"
          }
          EOF
          echo "âœ… OWASP ZAP scan complete"

      - name: Upload OWASP Report
        uses: actions/upload-artifact@v4
        with:
          name: owasp-zap-report
          path: owasp-zap-report/

  # ==========================================================================
  # STAGE 12: Lighthouse Report
  # ==========================================================================
  lighthouse:
    name: "ðŸ’¡ Stage 12: Lighthouse"
    runs-on: ubuntu-latest
    needs: setup
    env:
      ENV: ${{ needs.setup.outputs.environment }}
      TARGET: ${{ needs.setup.outputs.target_url }}
    steps:
      - name: "ðŸ” Log - Starting Lighthouse"
        run: |
          echo "=========================================="
          echo "ðŸ’¡ STAGE 12: LIGHTHOUSE REPORT (POST-DEPLOY)"
          echo "=========================================="
          echo "Environment: ${{ env.ENV }}"
          echo "Target URL: ${{ env.TARGET }}"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Install frontend dependencies
        working-directory: Web/app/fronted
        run: npm install

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, json, bcmath, tokenizer
          coverage: none

      - name: Install backend dependencies
        working-directory: Web/app/backend
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Run backend tests
        working-directory: Web/app/backend
        run: vendor/bin/phpunit --configuration phpunit.xml.dist

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli

      - name: Run Lighthouse
        run: |
          mkdir -p lighthouse-report

          lhci collect --url="${{ env.TARGET }}" \
            --settings.output=html \
            --settings.output=json \
            --settings.outputPath=./lighthouse-report/ || true

          # Also run with npx for backup
          npx lighthouse "${{ env.TARGET }}" \
            --output=html --output=json \
            --output-path=./lighthouse-report/lighthouse \
            --chrome-flags="--headless --no-sandbox" || true
        continue-on-error: true

      - name: "ðŸ“ Prepare Lighthouse Report"
        run: |
          cat > lighthouse-report/lighthouse-summary.json << EOF
          {
            "target": "${{ env.TARGET }}",
            "environment": "${{ env.ENV }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${{ github.event.workflow_run.head_sha }}",
            "branch": "${{ github.event.workflow_run.head_branch }}"
          }
          EOF

          echo "âœ… Lighthouse audit complete"

      - name: Upload Lighthouse Report
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-report
          path: lighthouse-report/

  # ==========================================================================
  # STAGE 13: Upload ALL Reports to S3
  # ==========================================================================
  upload-to-s3:
    name: "ðŸ“ Stage 13: Upload to S3"
    runs-on: ubuntu-latest
    needs: [setup, owasp-zap, lighthouse]
    env:
      ENV: ${{ needs.setup.outputs.environment }}
    steps:
      - name: "ðŸ” Log - Uploading Reports to S3"
        run: |
          echo "=========================================="
          echo "ðŸ“ STAGE 13: UPLOAD REPORTS TO S3"
          echo "=========================================="
          echo "Environment: ${{ env.ENV }}"
          echo "S3 Path: s3://artifacts/${{ env.ENV }}/$(date +%Y-%m-%d)/"

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download All Artifacts from Part 1
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: ci-cd-pipeline.yml
          path: ./artifacts
        continue-on-error: true

      - name: Download All Artifacts from Part 2
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: ci-cd-pipeline-part2.yml
          path: ./artifacts
        continue-on-error: true

      - name: Download OWASP Report
        uses: actions/download-artifact@v4
        with:
          name: owasp-zap-report
          path: ./artifacts/owasp-zap-report
        continue-on-error: true

      - name: Download Lighthouse Report
        uses: actions/download-artifact@v4
        with:
          name: lighthouse-report
          path: ./artifacts/lighthouse-report
        continue-on-error: true

      - name: "ðŸ“Š List All Artifacts"
        run: |
          echo ">>> Collected artifacts:"
          find ./artifacts -type f | head -100

      - name: "â˜ï¸ Upload to S3"
        run: |
          DATE=$(date +%Y-%m-%d)
          TIME=$(date +%H%M%S)
          RUN_ID="${{ github.run_id }}"
          BUCKET="${{ secrets.AWS_ACCOUNT_ID }}-web-app-security-artifacts"

          # S3 path structure: {env}/{date}/{run-id}/
          S3_PATH="s3://${BUCKET}/${{ env.ENV }}/${DATE}/${RUN_ID}"

          echo ">>> Uploading to ${S3_PATH}/"

          # Upload with folder structure
          aws s3 sync ./artifacts "${S3_PATH}/" \
            --metadata "environment=${{ env.ENV }},date=${DATE},run-id=${RUN_ID}" || echo "Bucket may not exist"

          # Create master index
          cat > index.json << EOF
          {
            "environment": "${{ env.ENV }}",
            "date": "${DATE}",
            "runId": "${RUN_ID}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${{ github.event.workflow_run.head_sha }}",
            "branch": "${{ github.event.workflow_run.head_branch }}",
      - name: "ðŸ” Log - Starting Smoke Tests"
        run: |
          echo "=========================================="
          echo "ðŸ§ª STAGE 14: SMOKE TESTS"
          echo "=========================================="
          echo "Environment: ${{ env.ENV }}"
          echo "Target: ${{ env.TARGET }}"

      - name: "ðŸš Shell Smoke Tests"
        run: |
          echo ">>> Running Shell smoke tests..."

          # Health check
          echo "Testing health endpoint..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ env.TARGET }}/health" || echo "000")
          echo "Health check: $HTTP_CODE"

          # Homepage test
          echo "Testing homepage..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ env.TARGET }}" || echo "000")
          echo "Homepage: $HTTP_CODE"

          # API test
          echo "Testing API..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ env.TARGET }}/api/health" || echo "000")
          echo "API health: $HTTP_CODE"

          echo "âœ… Shell smoke tests complete"

      - name: "ðŸ”§ PowerShell Smoke Tests"
        shell: pwsh
        run: |
          Write-Host ">>> Running PowerShell smoke tests..."
          $Target = "${{ env.TARGET }}"

          try {
            $Response = Invoke-WebRequest -Uri $Target -UseBasicParsing -TimeoutSec 30
            Write-Host "Status: $($Response.StatusCode)"
            Write-Host "Content Length: $($Response.Content.Length) bytes"
          } catch {
            Write-Host "Request failed: $_"
          }

          Write-Host "âœ… PowerShell smoke tests complete"

      - name: "ðŸ“Š Final Summary"
        run: |
          echo "=========================================="
          echo "ðŸ“Š PIPELINE COMPLETE - SUMMARY"
          echo "=========================================="
          echo ""
          echo "Environment: ${{ env.ENV }}"
          echo "Target URL: ${{ env.TARGET }}"
          echo "Commit: ${{ github.event.workflow_run.head_sha }}"
          echo "Branch: ${{ github.event.workflow_run.head_branch }}"
          echo ""
          echo "Security Artifacts Location:"
          echo "  S3: s3://${{ secrets.AWS_ACCOUNT_ID }}-web-app-security-artifacts/${{ env.ENV }}/$(date +%Y-%m-%d)/${{ github.run_id }}/"
          echo ""
          echo "âœ… All 14 stages completed successfully!"
